#!/bin/bash

# Build script for Kubernetes cluster - handles heavy setup that should be cached
set -e

# Source environment variables
source helpers/.env

echo "ğŸ—ï¸  Building Kubernetes cluster components..."
echo "Kubernetes version: $K8S_VERSION"
echo "Run 'helpers/versions.sh' to see all configured versions"
echo ""

# Ensure required directories exist
echo "ğŸ“ Creating required directories..."
mkdir -p logs etcd-data bin certs

# Step 1: Setup binaries and tools (heavy download, should be cached)
echo "ğŸ“¦ Step 1: Setting up binaries..."
./build-scripts/setup-binaries.sh

echo ""

# Step 2: Generate certificates (should be cached unless certs need refresh)
echo "ğŸ” Step 2: Generating certificates..."
./build-scripts/generate-certs.sh

echo ""

# Step 3: Setup kubeconfig (depends on certificates)
echo "âš™ï¸  Step 3: Setting up kubeconfig..."
./build-scripts/setup-kubeconfig.sh

echo ""
echo "âœ… Build phase complete!"
echo "   Binaries, certificates, and static configuration are ready"
echo "   These components are cached and will survive app restarts"

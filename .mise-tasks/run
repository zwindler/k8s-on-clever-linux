#!/bin/bash

# Main script to setup Kubernetes cluster using Clever Cloud workers
set -e

# Source environment variables
source .env

# Ensure required directories exist (needed for workers)
echo "ğŸ“ Creating required directories..."
mkdir -p logs etcd-data bin certs

echo "ğŸš€ Starting Kubernetes cluster setup..."
echo "Kubernetes version: $K8S_VERSION"
echo "Run './versions.sh' to see all configured versions"
echo ""
echo "âš¡ Using Clever Cloud workers for process management"
echo "   Services are automatically managed by systemd"
echo ""

# Step 1: Setup binaries and tools
echo "ğŸ“¦ Step 1: Setting up binaries..."
./setup-binaries.sh

echo ""

# Step 2: Generate certificates
echo "ğŸ” Step 2: Generating certificates..."
./generate-certs.sh

echo ""

# Step 3: Setup kubeconfig
echo "âš™ï¸  Step 3: Setting up kubeconfig..."
./setup-kubeconfig.sh

echo ""

# Step 4: Setup RBAC for worker nodes
echo "ğŸ”’ Step 4: Setting up RBAC for worker nodes..."
./setup-node-rbac.sh

echo ""

# Step 5: Generate bootstrap token
echo "ğŸ”‘ Step 5: Generating bootstrap token..."
./generate-bootstrap-token.sh

echo ""

# Step 6: Generate kube-proxy certificates
echo "ğŸ” Step 6: Generating kube-proxy certificates..."
./generate-kubeproxy-certs.sh

echo ""

# Step 7: Generate worker setup script
echo "ğŸ“ Step 7: Generating worker setup script..."
./generate-worker-script.sh

echo ""
echo "âœ… Kubernetes cluster setup complete!"
echo ""
echo "ğŸ”§ Running with Clever Cloud workers:"
echo "  â€¢ Worker 0: etcd database"
echo "  â€¢ Worker 1: kube-apiserver"
echo "  â€¢ Worker 2: kube-controller-manager"
echo "  â€¢ Worker 3: kube-scheduler"
echo "  â€¢ Worker 4: HTTP server"
echo ""
echo "ï¿½ Monitor workers:"
echo "  clever logs              # View all logs"
echo "  clever logs --follow     # Follow logs in real-time"
echo ""
echo "ğŸ“‹ To add worker nodes:"
echo "  1. Copy the generated setup-worker-node.sh to your external worker node"
echo "  2. Edit NODE_NAME and NODE_IP in the script"
echo "  3. Run the script with sudo privileges"
echo "  4. The script includes all necessary certificates and configurations"
echo ""
echo "ğŸ” Check cluster status:"
echo "  bin/kubectl get nodes"
echo "  bin/kubectl cluster-info"
echo ""
echo "âš™ï¸  Configuration:"
echo "  ./versions.sh                # Show current versions"
echo "  Edit .env file to update versions"
echo ""
echo "âœ… Setup complete! Workers are managed by Clever Cloud systemd."

